/*! cloud - v1.0.0 - 2018-02-01 */
private_cloud.controller("cloudComputerController", [ "$scope", "$state", "$sce", "$rootScope", "$http", "all_check_service", "$q", "$timeout", "$window", "$interval", "$location", "count_service", function(e, t, o, n, a, r, s, l, i, u, c, d) {
    function f(t, o) {
        t.vm = {
            state: o["OS-EXT-STS:vm_state"],
            text: e.vm_state[o["OS-EXT-STS:vm_state"]]
        }, t.task = {
            state: o["OS-EXT-STS:task_state"],
            text: e.task_state[o["OS-EXT-STS:task_state"]]
        }, t.power = {
            state: o["OS-EXT-STS:power_state"],
            text: e.power_state[o["OS-EXT-STS:power_state"]]
        };
    }
    function g(e, t) {
        angular.forEach(n.images, function(o, n) {
            t == o.id && (e.imageName = o.name);
        });
    }
    function h(e) {
        for (var t = 0; t < n.flavors.length; t++) if (n.flavors[t].id == e.flavor.id) return n.flavors[t];
    }
    e.url = c.path(), d.getCount(), e.searchCloud = "", e.warn = !1, e.warnText = [], 
    e.vm_state = {
        building: "创建中",
        active: "运行中",
        rescued: "灾备运行",
        paused: "暂停",
        suspended: "挂起",
        stopped: "停止",
        soft_deleted: "软删除",
        hard_deleted: "应删除",
        resized: "确认/回退(调整配置)? ",
        error: "错误"
    }, e.task_state = {
        null: "无",
        building: "孵化",
        image_snapshotting: "正在创建快照",
        image_backingup: "备份",
        pausing: "暂停",
        unpausing: "暂停恢复",
        suspending: "正在挂起",
        resuming: "挂起恢复",
        deleting: "正在删除",
        stopping: "正在停止",
        starting: "正在启动",
        rescuing: "灾难恢复",
        unrescuing: "灾难复原",
        rebuilding: "正在重建",
        powering_on: "打开电源",
        powering_off: "关闭电源",
        resizing: "调整配置",
        resize_confirming: "配置调整确认",
        scheduling: "调度",
        block_device_mapping: "块设备映射",
        networking: "网络映射",
        spawning: "正在生成",
        reboot_started_hard: "正在重启",
        rebuild_spawning: "重建孵化中",
        "powering-off": "正在关闭电源",
        resize_finish: "已经重建",
        resize_reverting: "调整撤销中",
        resize_migrated: "调整配置完毕",
        resize_migrating: "正在调整配置"
    }, e.power_state = {
        0: "无",
        1: "运行中",
        3: "暂停",
        4: "关闭",
        6: "崩溃",
        7: "挂起"
    }, e.cloudHost = [], n.images_promise.promise.then(function() {
        a({
            url: "/api/list_servers/detail",
            method: "GET",
            headers: n.headers
        }).then(function(t) {
            var o = t.data.servers;
            console.log(o), angular.forEach(o, function(t, o) {
                var r = {};
                r.ipData = [], angular.forEach(t.addresses, function(e, t) {
                    angular.forEach(e, function(e, t) {
                        console.log(e), r.ipData.push(e);
                    });
                }), r.flavor = h(t), r.name = t.name, r.id = t.id;
                var s = t.image.id;
                f(r, t), g(r, s), null == t["OS-EXT-STS:task_state"] && a({
                    url: "/api/server_action/" + t.id,
                    method: "POST",
                    headers: n.headers,
                    data: {
                        "os-getVNCConsole": {
                            type: "novnc"
                        }
                    }
                }).then(function(e) {
                    r.vnc = e.data.console.url;
                }, function(e) {
                    alert(e.statusText);
                }), e.cloudHost.push(r), null != t["OS-EXT-STS:task_state"] && (e["intervalInit" + o] = u(function() {
                    a({
                        url: "/api/list_servers/" + r.id,
                        method: "GET",
                        headers: n.headers
                    }).then(function(r) {
                        console.log(r);
                        var s = r.data.server;
                        f(e.cloudHost[o], s), e.cloudHost[o].flavor = h(s), null == s["OS-EXT-STS:task_state"] && (e.cloudHost[o].ipData = [], 
                        e.cloudHost[o].vnc = "", angular.forEach(s.addresses, function(t) {
                            angular.forEach(t, function(t) {
                                e.cloudHost[o].ipData.push(t), console.log(e.cloudHost[o].ipData);
                            });
                        }), u.cancel(e["intervalInit" + o]), e["intervalInit" + o] = null, a({
                            url: "/api/server_action/" + t.id,
                            method: "POST",
                            headers: n.headers,
                            data: {
                                "os-getVNCConsole": {
                                    type: "novnc"
                                }
                            }
                        }).then(function(t) {
                            e.cloudHost[o].vnc = t.data.console.url;
                        }, function(e) {
                            alert(e.statusText);
                        }));
                    }, function(e) {
                        alert(e.statusText);
                    });
                }, 1e3)), e.$on("ngRepeatFinished", function(e) {
                    $("#config" + o).popover({
                        html: !0,
                        content: '<table class="table table-bordered table-striped table-condensed"><tbody><tr><td width="100px">VCPUs</td><td width="100px">' + r.flavor.vcpus + "</td></tr><tr><td>内存</td><td>" + r.flavor.ram / 1024 + "</td></tr><tr><td>大小</td><td>" + r.flavor.disk + "</td></tr></tbody></table>"
                    });
                });
            });
        }, function(e) {
            alert(e.statusText);
        });
    }), e.deleteCloud = function(t, o, r) {
        confirm("您确定删除" + o + "吗？此操作不可恢复！") && a({
            url: "/api/list_servers/" + t,
            method: "DELETE",
            headers: n.headers
        }).then(function(t) {
            204 == t.status && (alert("操作成功"), e.cloudHost.splice(r, 1));
        }, function(e) {
            alert(e.statusText);
        });
    }, e.restartComputer = function(t, o) {
        a({
            url: "/api/server_action/" + t,
            method: "POST",
            headers: n.headers,
            data: {
                reboot: {
                    type: "HARD"
                }
            }
        }).then(function(r) {
            console.log(r), 202 == r.status && (alert(e.cloudHost[o].name + "重启成功"), e["restartComputer" + o] = u(function() {
                a({
                    url: "/api/list_servers/" + t,
                    method: "GET",
                    headers: n.headers
                }).then(function(t) {
                    console.log(t);
                    var n = t.data.server;
                    f(e.cloudHost[o], n), null == n["OS-EXT-STS:task_state"] && (u.cancel(e["restartComputer" + o]), 
                    e["restartComputer" + o] = null);
                }, function(e) {
                    alert(e.statusText);
                });
            }, 1e3));
        }, function(e) {
            alert(e.statusText);
        });
    }, e.all_check = !1, e.allCheck = function(t) {
        r.allCheck(t, e.cloudHost);
    }, e.itemCheck = function() {
        r.itemCheck(e, e.cloudHost);
    }, e.changeConfig = function() {
        e.coresChangeProgress = e.newConfig.vcpus - e.oldConfig.vcpus, e.ramChangeProgress = e.newConfig.ram / 1024 - e.oldConfig.ram / 1024, 
        e.showConfig = e.newConfig;
    }, e.resetConfigInfo = function(t, o) {
        e.newConfig = "", e.coresChangeProgress = 0, e.ramChangeProgress = 0, e.canSelectFlavors = angular.copy(n.flavors), 
        e.canSelectFlavors.splice(function(e) {
            for (var t = 0; t < n.flavors.length; t++) if (n.flavors[t].id == e) return t;
        }(t.flavor.id), 1), e.showConfig = t.flavor, e.cloudId = t.id, e.oldConfig = t.flavor, 
        e.key = o, d.getCount();
    }, e.submitConfig = function() {
        console.log(e.cloudId), console.log(e.newConfig), console.log(e.diskConfig), a({
            url: "/api/server_action/" + e.cloudId,
            method: "POST",
            headers: n.headers,
            data: {
                resize: {
                    flavorRef: e.newConfig.id,
                    "OS-DCF:diskConfig": e.diskConfig
                }
            }
        }).then(function(t) {
            console.log(t), $("#reset_config").modal("hide"), e.intervalConfig = u(function() {
                a({
                    url: "/api/list_servers/" + e.cloudId,
                    method: "GET",
                    headers: n.headers
                }).then(function(t) {
                    console.log(t);
                    var o = t.data.server;
                    f(e.cloudHost[e.key], o), e.cloudHost[e.key].flavor = h(o), null == o["OS-EXT-STS:task_state"] && (u.cancel(e.intervalConfig), 
                    e.intervalConfig = null);
                }, function(e) {
                    alert(e.statusText);
                });
            }, 1e3);
        }, function(e) {
            alert(e.statusText);
        });
    }, e.confirmConfig = function(o, r) {
        a({
            url: "/api/server_action/" + o,
            method: "POST",
            headers: n.headers,
            data: {
                confirmResize: null
            }
        }).then(function(s) {
            console.log(s), e.intervalConfirmConfig = u(function() {
                a({
                    url: "/api/list_servers/" + o,
                    method: "GET",
                    headers: n.headers
                }).then(function(o) {
                    console.log(o);
                    var n = o.data.server;
                    f(e.cloudHost[r], n), "stopped" == n["OS-EXT-STS:vm_state"] && (u.cancel(e.intervalConfirmConfig), 
                    e.intervalConfirmConfig = null, t.go("count.cloudComputer", {}, {
                        reload: !0
                    }));
                }, function(e) {
                    alert(e.statusText);
                });
            }, 1e3);
        }, function(e) {
            alert(e.statusText);
        });
    }, e.returnConfig = function(e, o) {
        a({
            url: "/api/server_action/" + e,
            method: "POST",
            headers: n.headers,
            data: {
                revertResize: null
            }
        }).then(function(e) {
            console.log(e), t.go("count.cloudComputer", {}, {
                reload: !0
            });
        }, function(e) {
            alert(e.statusText);
        });
    }, e.reconstruction = function(t, o) {
        e.cloudId = t, e.key = o, console.log(e.key), e.selectImage = "";
    }, e.submitResetCloudComputer = function() {
        console.log(e.selectImage), a({
            url: "/api/server_action/" + e.cloudId,
            method: "POST",
            headers: n.headers,
            data: {
                rebuild: {
                    imageRef: e.selectImage
                }
            }
        }).then(function(t) {
            console.log(t), 202 == t.status && ($("#reset_cloud_computer").modal("hide"), g(e.cloudHost[e.key], e.selectImage), 
            e.intervalReconstruction = u(function() {
                a({
                    url: "/api/list_servers/" + e.cloudId,
                    method: "GET",
                    headers: n.headers
                }).then(function(t) {
                    console.log(t);
                    var o = t.data.server;
                    f(e.cloudHost[e.key], o), null == o["OS-EXT-STS:task_state"] && (u.cancel(e.intervalReconstruction), 
                    e.intervalReconstruction = null);
                }, function(e) {
                    alert(e.statusText);
                });
            }, 1e3));
        }, function(e) {
            alert(e.statusText);
        });
    }, e.showCloud = function(t) {
        return !e.searchCloud || -1 != t.indexOf(e.searchCloud);
    }, e.toggleComputer = function(t, o, r, s) {
        var l = {};
        l["os-" + t] = null, a({
            url: "/api/server_action/" + o,
            method: "POST",
            headers: n.headers,
            data: l
        }).then(function(t) {
            console.log(t), e["intervalToggle" + r] = u(function() {
                a({
                    url: "/api/list_servers/" + o,
                    method: "GET",
                    headers: n.headers
                }).then(function(t) {
                    console.log(t);
                    var o = t.data.server;
                    f(e.cloudHost[r], o), null == o["OS-EXT-STS:task_state"] && (u.cancel(e["intervalToggle" + r]), 
                    e["intervalToggle" + r] = null);
                }, function(e) {
                    alert(e.statusText);
                });
            }, 1e3);
        }, function(e) {
            alert(e.statusText);
        });
    };
} ]);
//# sourceMappingURL=cloudComputer.min.js.map