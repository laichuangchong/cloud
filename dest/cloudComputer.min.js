/*! cloud - v1.0.0 - 2018-01-25 */
private_cloud.controller("cloudComputerController", [ "$scope", "$sce", "$rootScope", "$http", "all_check_service", "$q", "$timeout", "$window", "$interval", "$location", function(e, t, o, n, a, s, i, l, r, c) {
    e.url = c.path(), e.warn = !1, e.warnText = [], e.vm_state = {
        initialized: "创建",
        active: "运行",
        rescued: "灾备运行",
        paused: "暂停",
        suspended: "挂起",
        stopped: "停止",
        soft_deleted: "软删除",
        hard_deleted: "应删除",
        resized: "确认迁移",
        error: "错误"
    }, e.task_state = {
        null: "没有任务执行",
        building: "孵化",
        image_snapshotting: "正在创建快找",
        image_backingup: "备份",
        pausing: "暂停",
        unpausing: "暂停恢复",
        suspending: "正在挂起",
        resuming: "挂起恢复",
        deleting: "正在删除",
        stopping: "正在停止",
        starting: "正在启动",
        rescuing: "灾难恢复",
        unrescuing: "灾难复原",
        rebuilding: "正在重建",
        powering_on: "打开电源",
        powering_off: "关闭电源",
        resizing: "调整配置",
        resize_confirming: "配置调整确认",
        scheduling: "调度",
        block_device_mapping: "块设备映射",
        networking: "网络映射",
        spawning: "正在生成",
        reboot_started_hard: "正在重启",
        rebuild_spawning: "重建完成",
        "powering-off": "正在关闭电源"
    }, e.power_state = {
        0: "无",
        1: "运行中",
        3: "暂停",
        4: "关闭",
        6: "崩溃",
        7: "挂起"
    }, e.cloudHost = [], o.network_promise.promise.then(function() {
        n({
            url: "/api/list_servers/detail",
            method: "GET",
            headers: o.headers
        }).then(function(t) {
            var a = t.data.servers;
            console.log(a), angular.forEach(a, function(t, a) {
                var s = {};
                s.ipData = [], console.log(t.addresses), angular.forEach(t.addresses, function(e, t) {
                    angular.forEach(e, function(e, t) {
                        console.log(e), s.ipData.push(e);
                    });
                }), angular.forEach(o.flavors, function(e) {
                    e.id == t.flavor.id && (s.config = e);
                }), s.name = t.name, s.id = t.id;
                var i = t.image.id;
                s.vmState = e.vm_state[t["OS-EXT-STS:vm_state"]], s.taskState = e.task_state[t["OS-EXT-STS:task_state"]], 
                s.powerState = e.power_state[t["OS-EXT-STS:power_state"]], s.diskConfig = t["OS-DCF:diskConfig"], 
                console.log(s), angular.forEach(o.images, function(e, t) {
                    i == e.id && (s.imageName = e.name);
                }), n({
                    url: "/api/server_action/" + t.id,
                    method: "POST",
                    headers: o.headers,
                    data: {
                        "os-getVNCConsole": {
                            type: "novnc"
                        }
                    }
                }).then(function(e) {
                    s.vnc = e.data.console.url;
                }, function(e) {}), e.cloudHost.push(s), null != t["OS-EXT-STS:task_state"] && (e["intervalInit" + a] = r(function() {
                    n({
                        url: "/api/list_servers/" + s.id,
                        method: "GET",
                        headers: o.headers
                    }).then(function(t) {
                        console.log(t);
                        var o = t.data.server;
                        e.cloudHost[a].vmState = e.vm_state[o["OS-EXT-STS:vm_state"]], e.cloudHost[a].taskState = e.task_state[o["OS-EXT-STS:task_state"]], 
                        e.cloudHost[a].powerState = e.power_state[o["OS-EXT-STS:power_state"]], null == o["OS-EXT-STS:task_state"] && (e.cloudHost[a].ipData = [], 
                        angular.forEach(o.addresses, function(t, o) {
                            angular.forEach(t, function(t, o) {
                                e.cloudHost[o].ipData.push(t);
                            });
                        }), r.cancel(e["intervalInit" + a]), e["intervalInit" + a] = null);
                    }, function(e) {});
                }, 2e3)), e.$on("ngRepeatFinished", function(e) {
                    $("#config" + a).popover({
                        html: !0,
                        content: '<table class="table table-bordered table-striped table-condensed"><tbody><tr><td width="100px">VCPUs</td><td width="100px">' + s.config.vcpus + "</td></tr><tr><td>内存</td><td>" + s.config.ram / 1024 + "</td></tr><tr><td>大小</td><td>" + s.config.disk + "</td></tr></tbody></table>"
                    });
                });
            });
        }, function(e) {});
    }), e.deleteCloud = function(t, a, s) {
        confirm("您确定删除" + a + "吗？此操作不可恢复！") && n({
            url: "/api/list_servers/" + t,
            method: "DELETE",
            headers: o.headers
        }).then(function(t) {
            204 == t.status && (alert("操作成功"), e.cloudHost.splice(s, 1));
        }, function() {
            alert("操作失败请重试");
        });
    }, e.restart = function(e) {
        n({
            url: "/api/server_action/" + e,
            method: "POST",
            headers: o.headers,
            data: {
                reboot: {
                    type: "HARD"
                }
            }
        }).then(function(e) {
            202 == e.status && l.location.reload();
        }, function(e) {});
    }, e.all_check = !1, console.log(e.all_check), e.allCheck = function(t) {
        a.allCheck(t, e.cloudHost);
    }, e.itemCheck = function() {
        a.itemCheck(e, e.cloudHost);
    }, e.resetConfigInfo = function(t, a, s) {
        e.newConfig = t, e.diskConfig = a, e.cloudId = s, e.oldConfig = t, console.log(e.newConfig), 
        n({
            url: "/api/nova_limits",
            method: "GET",
            headers: o.headers
        }).then(function(t) {
            console.log(t.data.limits.absolute);
            var o = t.data.limits.absolute;
            e.count = {
                instances: {
                    title: "云主机",
                    used: o.totalInstancesUsed,
                    total: o.maxTotalInstances,
                    unit: "个"
                },
                cores: {
                    title: "VCPUs",
                    used: o.totalCoresUsed,
                    total: o.maxTotalCores,
                    unit: "个"
                },
                ram: {
                    title: "内存",
                    used: o.totalRAMUsed / 1024,
                    total: o.maxTotalRAMSize / 1024,
                    unit: "GB"
                }
            };
        }, function(e) {
            console.log(e);
        });
    }, e.changeConfig = function(t) {
        e.coresChangeProgress = t.vcpus - e.oldConfig.vcpus, e.ramChangeProgress = t.ram / 1024 - e.oldConfig.ram / 1024;
    }, e.submitConfig = function() {
        console.log(e.cloudId), console.log(e.newConfig), console.log(e.diskConfig), n({
            url: "/api/server_action/" + e.cloudId,
            method: "POST",
            headers: o.headers,
            data: {
                resize: {
                    flavorRef: e.newConfig.id,
                    "OS-DCF:diskConfig": e.diskConfig
                }
            }
        }).then(function(e) {
            console.log(e), 202 == e.status && $("#myModal").modal("hide");
        }, function(e) {
            console.log(e);
        });
    }, e.reconstruction = function(t) {
        e.cloudId = t;
    }, e.submitResetCloudComputer = function() {
        console.log(e.selectImage), n({
            url: "/api/server_action/" + e.cloudId,
            method: "POST",
            headers: o.headers,
            data: {
                rebuild: {
                    imageRef: e.selectImage
                }
            }
        }).then(function(e) {
            console.log(e), 202 == e.status && l.location.reload();
        }, function() {});
    }, e.searchCloud = "", e.showCloud = function(t) {
        return !e.searchCloud || -1 != t.indexOf(e.searchCloud);
    }, e.globalToggle = function(t) {
        var a = {};
        a["os-" + t] = null, angular.forEach(e.cloudHost, function(t, s) {
            t.check_status && (console.log(t.id), n({
                url: "/api/server_action/" + t.id,
                method: "POST",
                headers: o.headers,
                data: a
            }).then(function(a) {
                console.log(a), e["intervalToggle" + s] = r(function() {
                    n({
                        url: "/api/list_servers/" + t.id,
                        method: "GET",
                        headers: o.headers
                    }).then(function(t) {
                        console.log(t);
                        var o = t.data.server;
                        e.cloudHost[s].vmState = e.vm_state[o["OS-EXT-STS:vm_state"]], e.cloudHost[s].taskState = e.task_state[o["OS-EXT-STS:task_state"]], 
                        e.cloudHost[s].powerState = e.power_state[o["OS-EXT-STS:power_state"]], null == o["OS-EXT-STS:task_state"] && (r.cancel(e["intervalToggle" + s]), 
                        e["intervalToggle" + s] = null);
                    }, function(e) {});
                }, 2e3);
            }, function(o) {
                console.log(o), e.warn = !0, e.warnText.push("错误" + o.status + " 云主机：" + t.name + "操作失败");
            }));
        });
    };
} ]);
//# sourceMappingURL=cloudComputer.min.js.map