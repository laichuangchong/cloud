/*! cloud - v1.0.0 - 2018-01-29 */
private_cloud.controller("cloudComputerController", [ "$scope", "$sce", "$rootScope", "$http", "all_check_service", "$q", "$timeout", "$window", "$interval", "$location", function(e, t, o, n, a, s, l, i, r, c) {
    function d(t, o) {
        t.vm = {
            state: o["OS-EXT-STS:vm_state"],
            text: e.vm_state[o["OS-EXT-STS:vm_state"]]
        }, t.task = {
            state: o["OS-EXT-STS:task_state"],
            text: e.task_state[o["OS-EXT-STS:task_state"]]
        }, t.power = {
            state: o["OS-EXT-STS:power_state"],
            text: e.power_state[o["OS-EXT-STS:power_state"]]
        };
    }
    function u(e, t) {
        angular.forEach(o.images, function(o, n) {
            t == o.id && (e.imageName = o.name);
        });
    }
    e.url = c.path(), e.warn = !1, e.warnText = [], e.vm_state = {
        initialized: "创建",
        active: "运行",
        rescued: "灾备运行",
        paused: "暂停",
        suspended: "挂起",
        stopped: "停止",
        soft_deleted: "软删除",
        hard_deleted: "应删除",
        resized: "确认迁移",
        error: "错误"
    }, e.task_state = {
        null: "没有任务执行",
        building: "孵化",
        image_snapshotting: "正在创建快找",
        image_backingup: "备份",
        pausing: "暂停",
        unpausing: "暂停恢复",
        suspending: "正在挂起",
        resuming: "挂起恢复",
        deleting: "正在删除",
        stopping: "正在停止",
        starting: "正在启动",
        rescuing: "灾难恢复",
        unrescuing: "灾难复原",
        rebuilding: "正在重建",
        powering_on: "打开电源",
        powering_off: "关闭电源",
        resizing: "调整配置",
        resize_confirming: "配置调整确认",
        scheduling: "调度",
        block_device_mapping: "块设备映射",
        networking: "网络映射",
        spawning: "正在生成",
        reboot_started_hard: "正在重启",
        rebuild_spawning: "重建完成",
        "powering-off": "正在关闭电源"
    }, e.power_state = {
        0: "无",
        1: "运行中",
        3: "暂停",
        4: "关闭",
        6: "崩溃",
        7: "挂起"
    }, e.cloudHost = [], o.network_promise.promise.then(function() {
        n({
            url: "/api/list_servers/detail",
            method: "GET",
            headers: o.headers
        }).then(function(t) {
            var a = t.data.servers;
            console.log(a), angular.forEach(a, function(t, a) {
                var s = {};
                s.ipData = [], console.log(t.addresses), angular.forEach(t.addresses, function(e, t) {
                    angular.forEach(e, function(e, t) {
                        console.log(e), s.ipData.push(e);
                    });
                }), angular.forEach(o.flavors, function(e) {
                    e.id == t.flavor.id && (s.config = e);
                }), s.name = t.name, s.id = t.id;
                var l = t.image.id;
                d(s, t), s.diskConfig = t["OS-DCF:diskConfig"], console.log(s), u(s, l), n({
                    url: "/api/server_action/" + t.id,
                    method: "POST",
                    headers: o.headers,
                    data: {
                        "os-getVNCConsole": {
                            type: "novnc"
                        }
                    }
                }).then(function(e) {
                    s.vnc = e.data.console.url;
                }, function(e) {}), e.cloudHost.push(s), null != t["OS-EXT-STS:task_state"] && (e["intervalInit" + a] = r(function() {
                    n({
                        url: "/api/list_servers/" + s.id,
                        method: "GET",
                        headers: o.headers
                    }).then(function(s) {
                        console.log(s);
                        var l = s.data.server;
                        d(e.cloudHost[a], l), null == l["OS-EXT-STS:task_state"] && (e.cloudHost[a].ipData = [], 
                        e.cloudHost[a].vnc = "", console.log(l.addresses), angular.forEach(l.addresses, function(t) {
                            angular.forEach(t, function(t) {
                                e.cloudHost[a].ipData.push(t), console.log(e.cloudHost[a].ipData);
                            });
                        }), console.log(e.cloudHost[a].ipData), r.cancel(e["intervalInit" + a]), e["intervalInit" + a] = null, 
                        n({
                            url: "/api/server_action/" + t.id,
                            method: "POST",
                            headers: o.headers,
                            data: {
                                "os-getVNCConsole": {
                                    type: "novnc"
                                }
                            }
                        }).then(function(t) {
                            e.cloudHost[a].vnc = t.data.console.url;
                        }, function(e) {}));
                    }, function(e) {});
                }, 2e3)), e.$on("ngRepeatFinished", function(e) {
                    $("#config" + a).popover({
                        html: !0,
                        content: '<table class="table table-bordered table-striped table-condensed"><tbody><tr><td width="100px">VCPUs</td><td width="100px">' + s.config.vcpus + "</td></tr><tr><td>内存</td><td>" + s.config.ram / 1024 + "</td></tr><tr><td>大小</td><td>" + s.config.disk + "</td></tr></tbody></table>"
                    });
                });
            });
        }, function(e) {});
    }), e.deleteCloud = function(t, a, s) {
        confirm("您确定删除" + a + "吗？此操作不可恢复！") && n({
            url: "/api/list_servers/" + t,
            method: "DELETE",
            headers: o.headers
        }).then(function(t) {
            204 == t.status && (alert("操作成功"), e.cloudHost.splice(s, 1));
        }, function() {
            alert("操作失败请重试");
        });
    }, e.restartComputer = function(t, a) {
        n({
            url: "/api/server_action/" + t,
            method: "POST",
            headers: o.headers,
            data: {
                reboot: {
                    type: "HARD"
                }
            }
        }).then(function(s) {
            console.log(s), 202 == s.status && (e["restartComputer" + a] = r(function() {
                n({
                    url: "/api/list_servers/" + t,
                    method: "GET",
                    headers: o.headers
                }).then(function(t) {
                    console.log(t);
                    var o = t.data.server;
                    d(e.cloudHost[a], o), null == o["OS-EXT-STS:task_state"] && (r.cancel(e["restartComputer" + a]), 
                    e["restartComputer" + a] = null);
                }, function(e) {});
            }, 2e3));
        }, function(e) {
            alert(e.statusText);
        });
    }, e.all_check = !1, console.log(e.all_check), e.allCheck = function(t) {
        a.allCheck(t, e.cloudHost);
    }, e.itemCheck = function() {
        a.itemCheck(e, e.cloudHost);
    }, e.resetConfigInfo = function(t, a, s) {
        e.newConfig = t, e.diskConfig = a, e.cloudId = s, e.oldConfig = t, console.log(e.newConfig), 
        n({
            url: "/api/nova_limits",
            method: "GET",
            headers: o.headers
        }).then(function(t) {
            console.log(t.data.limits.absolute);
            var o = t.data.limits.absolute;
            e.count = {
                instances: {
                    title: "云主机",
                    used: o.totalInstancesUsed,
                    total: o.maxTotalInstances,
                    unit: "个"
                },
                cores: {
                    title: "VCPUs",
                    used: o.totalCoresUsed,
                    total: o.maxTotalCores,
                    unit: "个"
                },
                ram: {
                    title: "内存",
                    used: o.totalRAMUsed / 1024,
                    total: o.maxTotalRAMSize / 1024,
                    unit: "GB"
                }
            };
        }, function(e) {
            console.log(e), alert(e.statusText);
        });
    }, e.changeConfig = function(t) {
        e.coresChangeProgress = t.vcpus - e.oldConfig.vcpus, e.ramChangeProgress = t.ram / 1024 - e.oldConfig.ram / 1024;
    }, e.submitConfig = function() {
        console.log(e.cloudId), console.log(e.newConfig), console.log(e.diskConfig), n({
            url: "/api/server_action/" + e.cloudId,
            method: "POST",
            headers: o.headers,
            data: {
                resize: {
                    flavorRef: e.newConfig.id,
                    "OS-DCF:diskConfig": e.diskConfig
                }
            }
        }).then(function(e) {
            console.log(e), 202 == e.status && $("#reset_config").modal("hide");
        }, function(e) {
            console.log(e), alert(e.statusText);
        });
    }, e.reconstruction = function(t, o) {
        e.cloudId = t, e.key = o, e.selectImage = "";
    }, e.submitResetCloudComputer = function() {
        console.log(e.selectImage), n({
            url: "/api/server_action/" + e.cloudId,
            method: "POST",
            headers: o.headers,
            data: {
                rebuild: {
                    imageRef: e.selectImage
                }
            }
        }).then(function(t) {
            console.log(t), 202 == t.status && ($("#reset_cloud_computer").modal("hide"), u(e.cloudHost[e.key], e.selectImage), 
            e.intervalReconstruction = r(function() {
                n({
                    url: "/api/list_servers/" + e.cloudId,
                    method: "GET",
                    headers: o.headers
                }).then(function(t) {
                    console.log(t);
                    var o = t.data.server;
                    d(e.cloudHost[e.key], o), null == o["OS-EXT-STS:task_state"] && (r.cancel(e.intervalReconstruction), 
                    e.intervalReconstruction = null);
                }, function(e) {
                    alert(e.statusText);
                });
            }, 2e3));
        }, function(e) {
            alert(e.statusText);
        });
    }, e.searchCloud = "", e.showCloud = function(t) {
        return !e.searchCloud || -1 != t.indexOf(e.searchCloud);
    }, e.toggleComputer = function(t, a, s, l) {
        var i = {};
        i["os-" + t] = null, n({
            url: "/api/server_action/" + a,
            method: "POST",
            headers: o.headers,
            data: i
        }).then(function(t) {
            console.log(t), e["intervalToggle" + s] = r(function() {
                n({
                    url: "/api/list_servers/" + a,
                    method: "GET",
                    headers: o.headers
                }).then(function(t) {
                    console.log(t);
                    var o = t.data.server;
                    d(e.cloudHost[s], o), null == o["OS-EXT-STS:task_state"] && (r.cancel(e["intervalToggle" + s]), 
                    e["intervalToggle" + s] = null);
                }, function(e) {});
            }, 2e3);
        }, function(t) {
            console.log(t), e.warn = !0, e.warnText.push("错误" + t.status + " 云主机：" + l + "操作失败");
        });
    };
} ]);
//# sourceMappingURL=cloudComputer.min.js.map